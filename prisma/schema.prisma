generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

// ============================================
// AGENT-AGENT: COACHES EDITION
// ============================================

// Client model for multi-tenant support
model Client {
  id              String   @id @default(cuid())
  name            String
  email           String   @unique
  coachingNiche   String?
  targetAudience  String?
  tier            String   @default("TIER_1") // TIER_1, TIER_2
  status          String   @default("ACTIVE") // ACTIVE, PAUSED, CHURNED
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  pieces          Piece[]
  strategy        ClientStrategy?
  contentSeries   ContentSeries[]
  calendar        ContentCalendar?

  @@index([status])
  @@index([tier])
}

// Content pieces (podcasts, transcripts, voice memos, etc.)
model Piece {
  id              String   @id @default(cuid())
  clientId        String?
  title           String
  body            String   @db.Text
  source          String   // file name, "paste", "podcast", "voice_memo"
  sourceUrl       String?  // Original URL if applicable
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  wordCount       Int
  rawMetadataJson String   @default("{}")

  // Relations
  client          Client?  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  archivistTags   ArchivistTags?
  placement       Placement?
  repurposeOutputs RepurposeOutput[]

  @@index([clientId])
  @@index([createdAt])
}

// Archivist output
model ArchivistTags {
  id              String   @id @default(cuid())
  pieceId         String   @unique
  themesJson      String   @db.Text
  voiceTagsJson   String   @db.Text
  contentType     String   // PODCAST_TRANSCRIPT, VIDEO_TRANSCRIPT, VOICE_MEMO, etc.
  status          String   // READY, NEEDS_CLEANUP, RAW, ARCHIVE
  qualityBand     String   // A, B, C
  keyInsightsJson String   @db.Text @default("[]")
  notes           String   @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  piece           Piece    @relation(fields: [pieceId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([qualityBand])
  @@index([contentType])
}

// Placement output
model Placement {
  id                      String   @id @default(cuid())
  pieceId                 String   @unique
  primaryPlatform         String   // LINKEDIN, TWITTER, INSTAGRAM, EMAIL, BLOG, YOUTUBE, ARCHIVE
  secondaryPlatformsJson  String   @default("[]")
  contentPotential        String   // HIGH, MEDIUM, LOW
  recommendedFormatsJson  String   @default("[]")
  reasoning               String   @db.Text
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  piece                   Piece    @relation(fields: [pieceId], references: [id], onDelete: Cascade)

  @@index([primaryPlatform])
  @@index([contentPotential])
}

// Repurposed content outputs
model RepurposeOutput {
  id          String   @id @default(cuid())
  pieceId     String
  platform    String   // LINKEDIN, TWITTER, INSTAGRAM, EMAIL, BLOG
  format      String   // story, listicle, thread, caption, newsletter, outline
  contentJson String   @db.Text
  position    Int      @default(0)
  status      String   @default("DRAFT") // DRAFT, APPROVED, SCHEDULED, POSTED
  scheduledAt DateTime?
  postedAt    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  piece       Piece    @relation(fields: [pieceId], references: [id], onDelete: Cascade)

  @@index([pieceId])
  @@index([platform])
  @@index([status])
}

// Content series (email sequences, blog series, etc.)
model ContentSeries {
  id                      String   @id @default(cuid())
  clientId                String
  title                   String
  description             String   @db.Text
  theme                   String
  includedPieceIdsJson    String   @db.Text
  recommendedSequenceJson String   @db.Text
  seriesType              String   // EMAIL_SEQUENCE, BLOG_SERIES, LINKEDIN_SERIES, LEAD_MAGNET, COURSE_MODULE
  estimatedPieces         Int
  gapsJson                String   @db.Text @default("[]")
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  client                  Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([seriesType])
}

// 30-day content calendar
model ContentCalendar {
  id                  String   @id @default(cuid())
  clientId            String   @unique
  calendarJson        String   @db.Text  // Array of calendar entries
  weeklyBreakdownJson String   @db.Text
  strategyNotes       String   @db.Text
  contentGapsJson     String   @db.Text @default("[]")
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  client              Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

// Client strategy from Strategist agent
model ClientStrategy {
  id                    String   @id @default(cuid())
  clientId              String   @unique
  inputJson             String   @db.Text  // Original intake form data
  platformPriorityJson  String   @db.Text
  contentStrategyJson   String   @db.Text
  quickWinsJson         String   @db.Text
  recommendationsJson   String   @db.Text
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  client                Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

// VA assignments for Tier 2 clients
model VAAssignment {
  id          String   @id @default(cuid())
  clientId    String
  vaName      String
  vaEmail     String
  hoursPerMonth Int    @default(20)
  status      String   @default("ACTIVE") // ACTIVE, PAUSED
  startDate   DateTime @default(now())
  endDate     DateTime?
  notesJson   String   @db.Text @default("[]")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([clientId])
  @@index([status])
}

// Content posting log (for tracking what's been posted)
model PostingLog {
  id              String   @id @default(cuid())
  clientId        String
  repurposeOutputId String?
  platform        String
  postedAt        DateTime
  postUrl         String?  // Link to actual post
  metricsJson     String   @db.Text @default("{}") // views, likes, comments, etc.
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([clientId])
  @@index([platform])
  @@index([postedAt])
}

// Weekly reports for clients
model WeeklyReport {
  id              String   @id @default(cuid())
  clientId        String
  weekStartDate   DateTime
  contentPostedJson String @db.Text  // Summary of what was posted
  metricsJson     String   @db.Text  // Aggregated metrics
  recommendationsJson String @db.Text @default("[]")
  sentAt          DateTime?
  createdAt       DateTime @default(now())

  @@index([clientId])
  @@index([weekStartDate])
}
