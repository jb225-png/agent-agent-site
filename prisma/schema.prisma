generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model Piece {
  id              String   @id @default(cuid())
  title           String
  body            String   @db.Text
  source          String // file name or "paste"
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  wordCount       Int
  rawMetadataJson String   @default("{}")

  // Relations
  archivistTags   ArchivistTags?
  placement       Placement?
  repurposeOutputs RepurposeOutput[]

  @@index([createdAt])
}

model ArchivistTags {
  id              String   @id @default(cuid())
  pieceId         String   @unique
  themesJson      String   @db.Text
  voiceTagsJson   String   @db.Text
  status          String
  qualityBand     String
  notes           String   @db.Text
  lineageJson     String   @default("{}")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  piece           Piece    @relation(fields: [pieceId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([qualityBand])
}

model Placement {
  id                    String   @id @default(cuid())
  pieceId               String   @unique
  primaryLane           String
  secondaryJson         String   @default("[]")
  exclusivity           String
  recommendedNextAction String
  outletsJson           String   @default("[]")
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  piece                 Piece    @relation(fields: [pieceId], references: [id], onDelete: Cascade)

  @@index([primaryLane])
  @@index([exclusivity])
}

model RepurposeOutput {
  id        String   @id @default(cuid())
  pieceId   String
  format    String
  content   String   @db.Text
  createdAt DateTime @default(now())

  piece     Piece    @relation(fields: [pieceId], references: [id], onDelete: Cascade)

  @@index([pieceId])
  @@index([format])
}

model Collection {
  id                      String   @id @default(cuid())
  titleWorking            String
  positioning             String   @db.Text
  includedPieceIdsJson    String   @db.Text
  missingJson             String   @db.Text
  estimatedEffortHours    Float
  recommendedPriceBand    String
  launchReadiness         String
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  @@index([launchReadiness])
}

model WeeklyQueue {
  id              String   @id @default(cuid())
  weekStartDate   DateTime
  tasksJson       String   @db.Text
  doNotTouchJson  String   @default("[]")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([weekStartDate])
}
